<!-- Loading Spinner -->
<div *ngIf="isLoading$ | async" class="loading-box">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="loading-text">Cargando...</span>
</div>

<!--begin::Content wrapper-->
<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Content container-->
        <div id="kt_app_content_container" class="app-container container-xxl">
            <!--begin::Form-->
            <form id="kt_ecommerce_edit_order_form" class="form d-flex flex-column flex-lg-row"
                data-kt-redirect="apps/ecommerce/sales/listing.html">
                <!--begin::Aside column-->
                <div class="w-100 flex-lg-row-auto w-lg-250px mb-7 me-7 me-lg-10">
                    <!--begin::Order details-->
                    <div class="card card-flush py-4">
                        <!--begin::Card header-->
                        <div class="card-header">
                            <div class="card-title">
                                <h2>Factura de venta</h2>
                            </div>
                        </div>
                        <!--end::Card header-->
                        <!--begin::Card body-->
                        <div class="card-body pt-0">
                            <div class="d-flex flex-column gap-10">
                                <!--begin::Input group-->
                                <div class="fv-row">
                                    <!--begin::Auto-generated ID-->
                                    <div class="fw-bold fs-3">{{ formatFacturaId(factura_id) }}</div>
                                    <!--end::Input-->
                                    <!--begin::Label-->
                                    <!-- <label class="form-label"></label> -->
                                    <div class="fw-bold fs-4">fecha: {{ currentDate }}</div>
                                    <!--end::Label-->
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row">
                                    <!--begin::Select2-->
                                    <select class="form-select mb-2" placeholder="Metodo de pago"
                                        [(ngModel)]="metodo_pago_id" name="metodo_pago_id"
                                        (change)="onChangeMetodoPago($event)">
                                        <option [ngValue]="9999999" selected>Metodo de pago</option>

                                        <ng-container *ngIf="metodos_pagos">
                                            <ng-container *ngFor="let item of metodos_pagos">
                                                <option [ngValue]="item.id">{{ item.nombre }}</option>
                                            </ng-container>
                                        </ng-container>
                                    </select>
                                    <!--end::Select2-->
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row" *ngIf="bancos.length > 0">
                                    <!--begin::Select2-->
                                    <select class="form-select mb-2" placeholder="Metodo de pago" [(ngModel)]="banco_id"
                                        name="banco_id">
                                        <option [ngValue]="9999999" selected>Seleccione Banco</option>

                                        <ng-container *ngFor="let item of bancos">
                                            <option [ngValue]="item.id">{{ item.nombre }}</option>
                                        </ng-container>

                                    </select>
                                    <!--end::Select2-->
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row">
                                    <!--begin::Input-->
                                    <input type="text" name="monto_pago" class="form-control mb-2 text-end"
                                        placeholder="Monto" [(ngModel)]="monto_pago" appNumericInput disabled
                                        (focus)="seleccionarTexto($event)" />
                                    <!--end::Input-->
                                    <!--begin::Description-->
                                    <div class="fs-7 text-end">Monto.
                                    </div>
                                    <!--end::Description-->
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row">
                                    <!--begin::Input-->
                                    <input type="text" name="descuento_final" class="form-control mb-2 text-end"
                                        placeholder="Descuento" [(ngModel)]="descuento_final" appNumericInput
                                        (input)="onChangeDescuentoFinal()" (focus)="seleccionarTexto($event)" />
                                    <!--end::Input-->
                                    <!--begin::Description-->
                                    <div class="fs-7 text-end">Descuento.
                                    </div>
                                    <!--end::Description-->
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row" *ngIf="bancos.length <= 0">
                                    <!--begin::Input-->
                                    <input type="text" name="efectivo_recibido"
                                        class="form-control mb-2 text-end is-invalid" placeholder="Efectivo recibido"
                                        [(ngModel)]="efectivo_recibido" appNumericInput
                                        (focus)="seleccionarTexto($event)" (input)="onChangeEfectivo()" />
                                    <!--end::Input-->
                                    <!--begin::Description-->
                                    <div class="fs-7 text-end text-danger">Efectivo recibido.
                                    </div>
                                    <!--end::Description-->
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row fw-bold fs-4 totals-row" *ngIf="bancos.length <= 0">
                                    <div class="d-flex justify-content-between">
                                        <span>Vueltos:</span>
                                        <span class="text-end text-danger">
                                            $ {{ vueltos | number:'1.2-2' }}
                                        </span>
                                    </div>
                                </div>
                                <!--end::Input group-->

                                <!--begin::Input group-->

                                <div class="form-group">
                                    <label for="fileInput" class="form-label">Comprobante</label>
                                    <div class="custom-file-wrapper d-flex align-items-center">
                                        <!-- Input invisible pero funcional -->
                                        <input type="file" id="fileInput" class="custom-file-input"
                                            accept=".jpeg, .bmp, .jpg, .png, .gif, .webp"
                                            (change)="processFile($event)" />
                                        <!-- Botón estilizado para seleccionar archivos -->
                                        <label for="fileInput" class="custom-file-label btn btn-success w-100">
                                            Seleccionar imagen
                                        </label>
                                        <span class="file-name ms-2 text-truncate">
                                            {{ file_name?.name || "Ningún archivo seleccionado" }}
                                        </span>
                                        <button *ngIf="file_name" type="button"
                                            class="btn btn-icon-metodo text-danger ms-2" (click)="removeImage()">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Vista previa de la imagen -->

                                <div class="image-preview mt-3 d-flex justify-content-center">
                                    <ng-container *ngIf="imagen_previzualizada; else defaultIcon">
                                        <img [src]="imagen_previzualizada" alt="Previsualización de la imagen"
                                            class="img-thumbnail fixed-image-size" style="object-fit: cover;" />
                                    </ng-container>

                                    <ng-template #defaultIcon>
                                        <div class="img-thumbnail d-flex align-items-center justify-content-center"
                                            style="max-width: 150px; max-height: 150px; background-color: #f8f9fa;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"
                                                fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
                                                <path
                                                    d="M4.002 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h7.996a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4.002zm0 1h7.996c.554 0 1 .446 1 1v12c0 .554-.446 1-1 1H4.002c-.554 0-1-.446-1-1V2c0-.554.446-1 1-1zm2.5 2.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM1 13.5c0-.8.283-1.402.879-2 .576-.576 1.147-.99 2.121-1.342.937-.331 1.933-.408 2.925-.408s1.988.077 2.925.408c.974.352 1.545.766 2.121 1.342.596.598.879 1.2.879 2v.5H1v-.5zm1-.5h10v-.5c0-.8-.283-1.402-.879-2-.576-.576-1.147-.99-2.121-1.342C8.188 9.077 7.192 9 6.2 9c-.993 0-1.988.077-2.925.408-.974.352-1.545.766-2.121 1.342-.596.598-.879 1.2-.879 2v.5z" />
                                            </svg>
                                        </div>
                                    </ng-template>
                                </div>

                                <!--end::Input group-->

                                <!--begin::Input group-->
                                <div class="fv-row mt-3">

                                    <button type="button" (click)="save()" class="btn btn-primary btn-md w-100">
                                        <i class="ki-duotone ki-credit-cart fs-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        <span class="indicator-label">Editar Factura</span>
                                        <span class="indicator-progress" *ngIf="isLoading$ | async">Espere por favor...
                                            <span class="spinner-border spinner-border-sm align-middle ms-2"
                                                *ngIf="isLoading$ | async"></span>
                                        </span>
                                    </button>

                                    <!--begin::Button-->
                                    <a routerLink="/facturas/listado" class="btn btn-danger btn-md w-100 mt-4">
                                        <i class="ki-duotone ki-black-left"></i>
                                        Volver</a>
                                    <!--end::Button-->
                                </div>
                                <!--end::Input group-->
                            </div>
                        </div>
                        <!--end::Card header-->
                    </div>
                    <!--end::Order details-->
                </div>
                <!--end::Aside column-->
                <!--begin::Main column-->
                <div class="d-flex flex-column flex-lg-row-fluid gap-7 gap-lg-10">

                    <!--begin::Order details-->
                    <div class="card card-flush py-4">
                        <!--begin::Card header-->
                        <div class="card-header" style="display: block;">
                            <div class="row justify-content-between">
                                <div class="col-6 ">
                                    <h2 class="d-flex align-items-center">
                                        <i class="ki-duotone ki-user text-dark fs-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        Cliente:
                                    </h2>
                                    <small class="mx-2">{{ cliente.id === 0 ? 'No ha seleccionado un
                                        cliente': cliente.segmento?.nombre
                                        }}</small>
                                </div>
                                <div class="col-6 d-flex justify-content-end">
                                    <button (click)="buscarCliente()" class="btn btn-primary btn-icon me-2"
                                        placement="top" ngbTooltip="Buscar">
                                        <i class="ki-duotone ki-magnifier fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>

                                    <button (click)="crearCliente()" class="btn btn-success btn-icon me-2"
                                        placement="top" ngbTooltip="Crear">
                                        <i class="ki-duotone ki-user fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>

                                    <button (click)="resetearCliente()" class="btn btn-dark btn-icon me-2"
                                        placement="top" ngbTooltip="Resetear">
                                        <i class="ki-duotone ki-arrows-circle fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!--end::Card header-->
                        <!--begin::Card body-->
                        <div class="card-body pt-0">
                            <div class="row">
                                <div class="col-3">
                                    <!--begin::Input-->
                                    <input type="text" (keyup.enter)="buscarCliente()" name="identificacion_cliente"
                                        class="form-control mb-2" placeholder="Identificación"
                                        [(ngModel)]="cliente.identificacion" />
                                    <!--end::Input-->
                                </div>
                                <div class="col-6">
                                    <!--begin::Input-->
                                    <input type="text" (keyup.enter)="buscarCliente()" name="cliente_nombres"
                                        class="form-control mb-2 buscar-cliente-input" placeholder="Cliente"
                                        [(ngModel)]="cliente.nombres" />

                                    <!--end::Input-->
                                </div>
                                <div class="col-3">
                                    <!--begin::Input-->
                                    <input type="text" (keyup.enter)="buscarCliente()" name="celular_ciente"
                                        class="form-control mb-2" placeholder="Celular" [(ngModel)]="cliente.celular" />
                                    <!--end::Input-->
                                </div>
                            </div>
                        </div>
                        <!--end::Card header-->
                    </div>
                    <!--end::Order details-->

                    <!--begin::Order details-->
                    <div class="card card-flush py-4">
                        <!--begin::Card header-->
                        <div class="card-header" style="display: block;">
                            <div class="row justify-content-between">
                                <div class="col-3">
                                    <h2 class="d-flex align-items-center">
                                        <i class="ki-duotone ki-parcel text-dark fs-1"><span class="path1"></span><span
                                                class="path2"></span><span class="path3"></span><span
                                                class="path4"></span><span class="path5"></span></i>
                                        Articulo
                                    </h2>

                                    <small class="mx-2">{{ articulo.id === 0 ? 'No ha seleccionado ningun
                                        articulo': articulo.categoria?.nombre
                                        }}</small>
                                </div>

                                <div class="col-9 d-flex justify-content-end">
                                    <button (click)="buscarArticulos()" class="btn btn-primary btn-icon me-1"
                                        placement="top" ngbTooltip="Buscar">
                                        <i class="ki-duotone ki-magnifier fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>

                                    <button (click)="resetearArticulo()" class="btn btn-dark btn-icon me-1"
                                        placement="top" ngbTooltip="Resetear">
                                        <i class="ki-duotone ki-arrows-circle fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!--end::Card header-->
                        <!--begin::Card body-->
                        <div class="card-body pt-0">
                            <div class="d-flex flex-column gap-10">
                                <!--begin::Separator-->
                                <!-- <div class="separator"></div> -->
                                <!--end::Separator-->
                                <div class="row">
                                    <div class="col-5">
                                        <!--begin::Search products-->
                                        <div class="d-flex align-items-center position-relative">
                                            <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                            <input type="text" data-kt-ecommerce-edit-order-filter="search"
                                                class="form-control ps-12 buscar-articulo-input"
                                                placeholder="Buscar articulos" (keyup.enter)="buscarArticulos()"
                                                [(ngModel)]="buscar_articulo" name="buscar_articulo" />
                                        </div>
                                        <!--end::Search products-->
                                    </div>

                                    <div class="col-2">
                                        <select class="form-select unidad-id-articulo-select" name="unidad_id_articulo"
                                            placeholder="Select an option" [(ngModel)]="unidad_id_articulo"
                                            (change)="changeUnidadArticulo($event.target)">
                                            <option [ngValue]="9999999" selected>Seleccione</option>

                                            <ng-container *ngIf="articulo?.unidades">
                                                <ng-container *ngFor="let item of articulo.unidades">
                                                    <option [ngValue]="item.id">{{ item.nombre }}</option>
                                                </ng-container>
                                            </ng-container>
                                        </select>
                                        <!--begin::Description-->
                                        <div class="text-muted fs-7">Unidades
                                        </div>
                                        <!--end::Description-->
                                    </div>

                                    <div class="col-2">
                                        <!--begin::Input-->
                                        <input type="text" name="precio_general_articulo" class="form-control text-end"
                                            placeholder="Precio" appNumericInput [(ngModel)]="precio_general_articulo"
                                            disabled />
                                        <!--end::Input-->
                                        <!--begin::Description-->
                                        <div class="text-muted fs-7 text-end">Precio.
                                        </div>
                                        <!--end::Description-->
                                    </div>

                                    <div class="col-2">
                                        <!--begin::Input-->
                                        <input type="text" name="cantidad_articulo"
                                            class="form-control text-end cantidad-input" placeholder="Cantidad"
                                            appNumericInput [(ngModel)]="cantidad_articulo"
                                            (focus)="seleccionarTexto($event)" />
                                        <!--end::Input-->
                                        <!--begin::Description-->
                                        <div class="text-muted fs-7">Cantidad.
                                        </div>
                                        <!--end::Description-->
                                    </div>

                                    <div class="col-1">
                                        <button (click)="agregarArticulo()" class="btn btn-success btn-icon me-1"
                                        *ngIf="!factura_id"
                                            placement="top" ngbTooltip="Agregar">
                                            <i class="ki-duotone ki-plus fs-1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span></i>
                                        </button>
                                    </div>

                                    <div class="col-3">
                                        <select class="form-select" name="bodega_id_articulo"
                                            placeholder="Seleccione bodega" [(ngModel)]="bodega_id_articulo">
                                            <option [ngValue]="9999999" selected>Seleccione Bodega</option>

                                            <ng-container *ngFor="let item of bodegas_articulos">
                                                <option [ngValue]="item.bodega.id">{{ item.bodega.nombre }} ({{
                                                    item.cantidad
                                                    }})
                                                </option>
                                            </ng-container>
                                        </select>
                                        <!--begin::Description-->
                                        <div class="text-muted fs-7">Bodegas.
                                        </div>
                                        <!--end::Description-->
                                    </div>

                                    <div [class.col-3]="articulo.id!== 0 && articulo.is_discount === 2"
                                        [class.d-none]="!(articulo.id!== 0 && articulo.is_discount === 2)"
                                        style="flex: 1;">
                                        <input type="text" #descuento name="monto_descuento"
                                            class="form-control text-end" placeholder="Descuento" appNumericInput
                                            [(ngModel)]="monto_descuento" (focus)="seleccionarTexto($event)" />

                                        <!--begin::Description-->
                                        <div class="text-muted fs-7">Descuento.
                                        </div>
                                        <!--end::Description-->
                                    </div>

                                    <div class="col-4 d-flex flex-column"
                                        [class.col-3]="articulo.id!== 0 && articulo.is_discount === 2"
                                        [class.d-none]="!(articulo.id!== 0 && articulo.is_discount === 2)"
                                        style="flex: 1;">
                                        <ul>
                                            <li>
                                                Mínimo:
                                                <span class="text-danger">
                                                    $ {{ descuentoMinimoValor | number:'1.2-2' }}
                                                    ({{ articulo.descuento_minimo }}%)
                                                </span>
                                            </li>
                                            <li>
                                                Máximo:
                                                <span class="text-danger">
                                                    $ {{ descuentoMaximoValor | number:'1.2-2' }}
                                                    ({{ articulo.descuento_maximo }}%)
                                                </span>
                                            </li>
                                        </ul>
                                    </div>

                                    <div [class.col-5]="unidad_id_articulo !== 9999999"
                                        [class.d-none]="unidad_id_articulo === 9999999 || (bodegas_articulos.length === 0 && exist_bodegas.length === 0)"
                                        class="d-flex flex-column" style="flex: 1;">
                                        <ul>
                                            <li *ngIf="unidad_id_articulo !== 9999999 && bodegas_articulos.length === 0"
                                                class="text-danger">
                                                No existe cantidad para esta unidad disponible en ninguna sede
                                            </li>
                                            <li *ngIf="unidad_id_articulo !== 9999999 && bodegas_articulos.length > 0 && exist_bodegas.length === 0"
                                                class="text-danger">
                                                No existe de esta unidad disponible en esta sede
                                            </li>
                                        </ul>
                                    </div>

                                    <div [class.col-6]="articulo && articulo.is_gift === 2"
                                        [class.d-none]="!(articulo && articulo.is_gift === 2)" style="flex: 1;">
                                        <!--begin::Label-->
                                        <label class="form-label">¿Es gratuito?</label>
                                        <!--end::Label-->
                                        <!--begin::Input-->
                                        <div class="form-check form-check-custom form-check-solid mb-2">
                                            <input class="form-check-input" type="checkbox" (click)="isGift()"
                                                [checked]="is_gift === 2" />
                                            <label class="form-check-label">Costo $0</label>
                                        </div>
                                        <!--end::Input-->
                                        <!--begin::Description-->
                                        <!-- <div class="text-muted fs-7">Es posible que el articulo no tenga ningun costo</div> -->
                                        <!--end::Description-->
                                    </div>

                                </div>

                                <div class="separator"></div>

                                <!--begin::Total price-->

                                <div class="row fw-bold fs-6 totals-row">
                                    <div class="col-3">
                                        Subtotal:
                                    </div>

                                    <div class="col-3">
                                        <span id="kt_ecommerce_edit_order_total_price">
                                            $ {{ getSubtotal() | number:'1.2-2' }}
                                        </span>
                                    </div>
                                </div>

                                <div class="row fw-bold fs-6 totals-row">
                                    <div class="col-3">
                                        Descuento:
                                    </div>

                                    <div class="col-3">
                                        <span id="kt_ecommerce_edit_order_total_price">
                                            $ {{ getTotalDescuento() | number:'1.2-2' }}
                                        </span>
                                    </div>
                                </div>

                                <div class="row fw-bold fs-6 totals-row">
                                    <div class="col-3">
                                        Iva:
                                    </div>

                                    <div class="col-3">
                                        <span id="kt_ecommerce_edit_order_total_price">
                                            $ {{ iva | number:'1.2-2' }}
                                        </span>
                                    </div>
                                </div>

                                <div class="row fw-bold fs-6 totals-row">
                                    <div class="col-3">
                                        Costo Total:
                                    </div>

                                    <div class="col-3">
                                        <span id="kt_ecommerce_edit_order_total_price">
                                            $ {{ getTotalCosto() | number:'1.2-2' }}
                                        </span>
                                    </div>
                                </div>
                                <!--end::Total price-->
                            </div>
                        </div>
                        <!--end::Card header-->
                    </div>
                    <!--end::Order details-->

                    <!--begin::Order details-->
                    <div class="card card-flush py-4">
                        <!--begin::Card header-->
                        <div class="card-header" style="display: block;">
                            <div class="row justify-content-between">
                                <div class="col-5">
                                    <h2 class="d-flex align-items-center">
                                        <i class="ki-duotone ki-questionnaire-tablet text-dark fs-1"><span
                                                class="path1"></span><span class="path2"></span></i>
                                        Detalle de la factura
                                    </h2>
                                </div>

                            </div>
                        </div>
                        <!--end::Card header-->
                        <!--begin::Card body-->
                        <div class="card-body pt-0">
                            <div class="d-flex flex-column gap-10">

                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-responsive">
                                            <!--begin::Table-->
                                            <table
                                                class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                                <!--begin::Table head-->
                                                <thead>
                                                    <tr class="fw-bold text-muted">
                                                        <th class="min-w-150px">Articulo</th>
                                                        <th class="min-w-120px text-end">Precio</th>
                                                        <th class="min-w-120px text-end">Cantidad</th>
                                                        <th class="min-w-120px text-end">Subtotal</th>
                                                        <th class="min-w-120px text-end">Iva</th>
                                                        <th class="min-w-120px text-end">Descuento</th>
                                                        <th class="min-w-120px text-end">Total</th>
                                                        <th class="min-w-100px text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <!--end::Table head-->
                                                <!--begin::Table body-->
                                                <tbody>
                                                    <ng-container *ngFor="let item of detalle_factura; let i=index;">
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div
                                                                        class="d-flex justify-content-start flex-column">
                                                                        <a style="text-transform: capitalize;" href="#"
                                                                            onclick="return false;"
                                                                            style="text-wrap: nowrap;"
                                                                            class="text-gray-900 fw-bold text-hover-primary mb-1 fs-6">{{
                                                                            item.articulo?.nombre }}</a>
                                                                        <span
                                                                            class="text-muted fw-semibold text-muted d-block fs-7">{{
                                                                            item.unidad?.nombre
                                                                            }}</span>

                                                                    </div>
                                                                </div>
                                                            </td>

                                                            <td>
                                                                <a href="#" onclick="return false;"
                                                                    class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6 text-end">$
                                                                    {{ item.precio_item | number:'1.2-2' }}</a>
                                                                <!-- <span
                                                                    class="text-muted fw-semibold text-muted d-block fs-7">Code:
                                                                    Paid</span> -->
                                                            </td>

                                                            <td>
                                                                <a href="#" onclick="return false;"
                                                                    class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6 text-end">{{
                                                                    item.cantidad_item }}</a>
                                                                <!-- <span
                                                                    class="text-muted fw-semibold text-muted d-block fs-7">Web,
                                                                    UI/UX Design</span> -->
                                                            </td>

                                                            <td class="text-gray-900 fw-bold text-hover-primary fs-6 text-end"
                                                                style="text-wrap: nowrap;">
                                                                $ {{ item.sub_total | number:'1.2-2' }}</td>

                                                            <td>
                                                                <a href="#" onclick="return false;"
                                                                    class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6 text-end">$
                                                                    {{
                                                                    item.total_iva | number:'1.2-2'}}
                                                                </a>
                                                            </td>

                                                            <td>
                                                                <a href="#" onclick="return false;"
                                                                    class="text-gray-900 fw-bold text-hover-primary d-block mb-1 fs-6 text-end">$
                                                                    {{
                                                                    item.total_descuento | number:'1.2-2'}}
                                                                </a>
                                                            </td>

                                                            <td class="text-gray-900 fw-bold text-hover-primary fs-6 text-end"
                                                                style="text-wrap: nowrap;">
                                                                $ {{ item.total_precio | number:'1.2-2' }}</td>

                                                            <td class="text-center">

                                                                <a href="#" onclick="return false;"
                                                                    (click)="editarArticulo(item,i)"
                                                                    *ngIf="item.estado === 1"
                                                                    class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1">
                                                                    <i class="ki-duotone ki-pencil fs-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                    </i>
                                                                </a>
                                                                <a href="#" onclick="return false;"
                                                                    (click)="eliminarArticulo(item,i)"
                                                                    *ngIf="item.estado === 1"
                                                                    class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm">
                                                                    <i class="ki-duotone ki-trash fs-2">
                                                                        <span class="path1"></span>
                                                                        <span class="path2"></span>
                                                                        <span class="path3"></span>
                                                                        <span class="path4"></span>
                                                                        <span class="path5"></span>
                                                                    </i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    </ng-container>
                                                </tbody>
                                                <!--end::Table body-->
                                            </table>
                                            <!--end::Table-->
                                        </div>
                                    </div>
                                </div>

                                <div class="separator"></div>

                                <!--begin::Total price-->
                                <div class="row">
                                    <!-- Columna izquierda: Contenido -->
                                    <div class="col-5">
                                        <div class="row fw-bold fs-6 mb-2">
                                            <div class="col-4">Subtotal:</div>
                                            <div class="col-4 text-end">
                                                <span id="kt_ecommerce_edit_order_total_price">
                                                    $ {{ subtotal_factura | number:'1.2-2' }}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="row fw-bold fs-6 mb-2">
                                            <div class="col-4">Iva:</div>
                                            <div class="col-4 text-end">
                                                <span id="kt_ecommerce_edit_order_total_price">
                                                    $ {{ total_iva_factura | number:'1.2-2' }}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="row fw-bold fs-6 mb-2">
                                            <div class="col-4">Descuento:</div>
                                            <div class="col-4 text-end">
                                                <span id="kt_ecommerce_edit_order_total_price">
                                                    $ {{ total_descuento_factura | number:'1.2-2' }}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="row fw-bold fs-6 mb-2">
                                            <div class="col-4">Costo Total:</div>
                                            <div class="col-4 text-end">
                                                <span id="kt_ecommerce_edit_order_total_price">
                                                    $ {{ total_costo_factura | number:'1.2-2' }}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="separator my-3"></div>

                                        <div class="row fw-bold fs-6 mb-2">
                                            <div class="col-4">Deuda:</div>
                                            <div class="col-4 text-end">
                                                <span id="kt_ecommerce_edit_order_total_price">
                                                    $ {{ (deuda - (monto_pago ? monto_pago : 0) - (descuento_final ?
                                                    descuento_final : 0)) | number:'1.2-2' }}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="row fw-bold fs-6 mb-2">
                                            <div class="col-4">Pagado:</div>
                                            <div class="col-4 text-end">
                                                <span id="kt_ecommerce_edit_order_total_price">
                                                    $ {{ (pago_out + (monto_pago ? monto_pago : 0)) | number:'1.2-2' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Columna derecha: Textarea -->
                                    <div class="col-7">
                                        <textarea [(ngModel)]="descripcion" class="form-control w-100"
                                            name="descripcion" placeholder="Observaciones" rows="8"></textarea>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!--begin::Order details-->
                    <div class="card card-flush py-4">
                        <!--begin::Card header-->
                        <div class="card-header" style="display: block;">
                            <div class="row justify-content-between">
                                <div class="col-3">
                                    <h2 class="d-flex align-items-center">
                                        <i class="ki-duotone ki-delivery-geolocation text-dark fs-1"><span
                                                class="path1"></span><span class="path2"></span><span
                                                class="path3"></span><span class="path4"></span><span
                                                class="path5"></span></i>
                                        Lugar de entrega
                                    </h2>
                                </div>

                                <div class="col-9 d-flex justify-content-end">

                                    <button class="btn btn-dark btn-icon" placement="top" ngbTooltip="Resetear"
                                        (click)="resetearLugarDeEntrega()">
                                        <i class="ki-duotone ki-arrows-circle fs-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!--end::Card header-->
                        <!--begin::Card body-->
                        <div class="card-body pt-0">
                            <div class="row">

                                <div class="col-4">
                                    <select class="form-select mb-2" name="sede_deliverie_id"
                                        placeholder="Seleccione lugar de entrega" [(ngModel)]="sede_deliverie_id"
                                        (change)="onChangeSedeDeliverie($event)">
                                        <option [ngValue]="9999999" selected>Lugar de entrega</option>
                                        <ng-container *ngFor="let item of sede_deliveries">
                                            <option [value]="item.id">{{ item.nombre }}</option>
                                        </ng-container>
                                    </select>
                                </div>


                                <div class="col-5" *ngIf="isDomicilio">
                                    <textarea type="text" name="direccion_deliverie" class="form-control mb-3 mb-lg-0"
                                        placeholder="Dirección" [(ngModel)]="direccion_deliverie"></textarea>
                                </div>

                                <div class="col-3">
                                    <div class="input-group ">
                                        <input type="date" name="fecha_deliverie" class="form-control form-control-lg "
                                            [(ngModel)]="fecha_deliverie" />
                                    </div>
                                    <!--begin::Description-->
                                    <div class="text-muted fs-7">Fecha de entrega.
                                    </div>
                                    <!--end::Description-->
                                </div>

                            </div>

                            <div *ngIf="isDomicilio">
                                <div class="row fv-row my-1 fv-plugins-icon-container">
                                    <div class="col-3">
                                        <select class="form-select fw-bolder" name="departamento_id"
                                            data-control="select2" placeholder="Departamento"
                                            [(ngModel)]="departamento_id_deliverie">
                                            <option [ngValue]="9999999" selected>Departamento</option>

                                            <ng-container *ngFor="let item of departamentos ">
                                                <option [value]="item.id">{{ item.nombre }}</option>
                                            </ng-container>
                                        </select>
                                    </div>

                                    <div class="col-5">
                                        <select class="form-select fw-bolder" name="municipio_id_deliverie"
                                            data-control="select2" placeholder="Municipio"
                                            [(ngModel)]="municipio_id_deliverie">
                                            <option [ngValue]="9999999" selected>Municipio</option>

                                            <ng-container
                                                *ngFor="let item of $any(municipios[departamento_id_deliverie])">
                                                <option [value]="item.id">{{ item.nombre }}</option>
                                            </ng-container>
                                        </select>
                                    </div>

                                    <div class="col-4">
                                        <!--begin::Input-->
                                        <input type="text" name="agencia_deliverie" class="form-control mb-2"
                                            placeholder="Agencia de envio" [(ngModel)]="agencia_deliverie" />
                                        <!--end::Input-->
                                    </div>
                                </div>

                                <div class="row fv-row my-1 fv-plugins-icon-container">
                                    <div class="col-4">
                                        <!--begin::Input-->
                                        <input type="text" name="encargado_deliverie" class="form-control mb-2"
                                            placeholder="Nombre encargado" [(ngModel)]="encargado_deliverie" />
                                        <!--end::Input-->
                                    </div>

                                    <div class="col-4">
                                        <!--begin::Input-->
                                        <input type="text" name="documento_deliverie" class="form-control mb-2"
                                            placeholder="Documento encargado" [(ngModel)]="documento_deliverie" />
                                        <!--end::Input-->
                                    </div>

                                    <div class="col-4">
                                        <!--begin::Input-->
                                        <input type="text" name="celular_deliverie" class="form-control mb-2"
                                            placeholder="Celular encargado" [(ngModel)]="celular_deliverie" />
                                        <!--end::Input-->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--end::Card body-->
                    </div>
                    <!--end::Order details-->

                </div>
                <!--end::Main column-->
            </form>
            <!--end::Form-->
        </div>
        <!--end::Content container-->
    </div>
    <!--end::Content-->
</div>
<!--end::Content wrapper-->